<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h2>Recommect の 広告の cookie 発行ページです。</h1>

    <h3>
      本ページを複数ドメインで検証する場合は、以下のリンクを広告で設定したURLと同一のものにして遷移してください。
    </h3>
    <a href="https://tk-cv-sample.herokuapp.com">中間地点ページへ</a>

    <!-- ここに着地点タグを挿入します -->
    <script>
      const rmtRelay = () => {
        const RMT_AD_ID_KEY = 'rmt_ad_id'
        const RMT_SID_KEY = 'rmt_sid'
        const salesPageUrl = 'https://tk-cv-sample.herokuapp.com'

        const saveCookiesAndLocalStorage = (data) => {
          const rmtAdIdValue = data[RMT_AD_ID_KEY]
          const rmtSidValue = data[RMT_SID_KEY]

          if (!rmtAdIdValue || !rmtSidValue) {
            assignParamsToLinks()
            return
          }

          setRecommectLocalStorage(rmtAdIdValue, rmtSidValue)
          setRecommectCookie(rmtAdIdValue, rmtSidValue)
        }

        const assignParamsToLinks = () => {
          const kvs = fetchDataFromCookieOrLocalStorage()
          const params = new URLSearchParams(kvs)

          const nodes = Array.from((document.querySelectorAll(`[href^='${salesPageUrl}']`)))
          nodes.forEach((node) => {
            let url = node.getAttribute('href')
            if (url.includes('?')) {
              url += `&${params}`
            } else {
              url += `?${params}`
            }
            node.setAttribute('href', url);
          })
        }

        const fetchUrlParameters = () => {
          const urlSearchParamsPairs = location.search
            .substring(1)
            .split('&')
            .map((params) => params.split('='))
          const kvPairs = Object.fromEntries(urlSearchParamsPairs)
          return kvPairs
        }

        const fetchDataFromCookieOrLocalStorage = () => {
          // Cookie Data
          const baseArray = document.cookie.split('; ')
          const rmtAdId = baseArray.find((val) => val.includes(RMT_AD_ID_KEY))?.split('=')[1]
          const kvsArray = baseArray.map((_kvs) => _kvs.replace(`_${rmtAdId}`, '').slice(1).split('='))
                                    .filter(([k, _]) => k.includes(RMT_AD_ID_KEY) || k.includes(RMT_SID_KEY))
          const kvs = Object.fromEntries(kvsArray)

          // localStorage Data
          const lsKeys = Object.keys(localStorage)
          const lsRmtAdId = lsKeys.find((val) => val.includes(RMT_AD_ID_KEY))?.replace(`_${RMT_AD_ID_KEY}_`, '')
          const lsKvsArray = lsKeys.map((_key) => {
                               const key = _key.replace(`_${lsRmtAdId}`, '').slice(1)
                               const value = localStorage.getItem(_key)
                               return [key, value]
                             })
                             .filter(([k, _]) => k.includes(RMT_AD_ID_KEY) || k.includes(RMT_SID_KEY))
          const lsKvs = Object.fromEntries(lsKvsArray)

          // Cookie と localStorage のうち Cookie にある値を優先して merge
          const kvPairs = {...lsKvs, ...kvs}
          return kvPairs
        }

        const setRecommectLocalStorage = (rmtAdIdValue, rmtSidValue) => {
          // Set AD_ID localStorage
          const adIdCookieKey = `_${RMT_AD_ID_KEY}_${rmtAdIdValue}`
          localStorage.setItem(adIdCookieKey, rmtAdIdValue)

          // Set SID localStorage
          const sidCookieKey = `_${RMT_SID_KEY}_${rmtAdIdValue}`
          localStorage.setItem(sidCookieKey, rmtSidValue)
        }

        const setRecommectCookie = (rmtAdIdValue, rmtSidValue) => {
          const xhr = new XMLHttpRequest()
          const issueCookiesUrl = `./issue_cookies.php?${RMT_AD_ID_KEY}=${rmtAdIdValue}&${RMT_SID_KEY}=${rmtSidValue}`
          xhr.open('GET', issueCookiesUrl)
          xhr.onloadend = () => {
            if (xhr.status === 200) {
              assignParamsToLinks()
            } else {
              // Cookie Options
              const date = new Date()
              date.setDate(date.getDate() + 90) // 90 days after
              const cookieOptions = `; expires=${date.toUTCString()}; path=/; SameSite=lax; Secure;`

              // Set AD_ID Cookie
              const adIdCookieKey = `_${RMT_AD_ID_KEY}_${rmtAdIdValue}`
              document.cookie = `${adIdCookieKey}=${rmtAdIdValue}${cookieOptions}`

              // Set SID Cookie
              const sidCookieKey = `_${RMT_SID_KEY}_${rmtAdIdValue}`
              document.cookie = `${sidCookieKey}=${rmtSidValue}${cookieOptions}`

              assignParamsToLinks()
            }
          }
          xhr.send()
        }

        // Main Logic
        const urlParameters = fetchUrlParameters()
        saveCookiesAndLocalStorage(urlParameters)
      }

      if (document.readyState !== 'complete') {
        document.addEventListener('DOMContentLoaded', rmtRelay);
      } else {
        rmtRelay();
      }
    </script>
    <!-- ------------------------- -->

    <!-- ※ 同階層に issue_cookie.php を配置してください -->
  </body>
</html>
